# 受講生CSV一括インポート仕様書

## 📋 概要

Mentorship Managerアプリケーションでは、CSVファイルを使用して受講生情報を一括登録できます。
この仕様書では、CSVファイルの形式、各列の詳細、バリデーションルール、および外部システムとの連携方法を説明します。

## 🔄 対応フォーマット

本システムは以下の2つのCSVフォーマットに対応しています:

1. **Mentorship Manager標準フォーマット** - 9列の簡易フォーマット
2. **Article Platform連携フォーマット** - 24列のゲーミフィケーション要素を含むフォーマット

どちらのフォーマットでも、**ヘッダー行を自動検出**してフィールドをマッピングします。

## 📄 CSVファイル形式

### 基本情報

- **ファイル形式**: CSV (Comma-Separated Values)
- **文字エンコーディング**: UTF-8 (BOM付き推奨)
- **改行コード**: LF (`\n`) または CRLF (`\r\n`)
- **区切り文字**: カンマ (`,`)
- **ヘッダー行**: 必須（1行目）
- **パース方式**: RFC 4180準拠（ダブルクォートエスケープ対応）

### ファイル構造

```
ヘッダー行（1行目）
データ行1（2行目）
データ行2（3行目）
...
```

## 📊 Mentorship Manager標準フォーマット

### 列の順序

| 列番号 | 列名 | 英語フィールド名 | 必須 | データ型 |
|--------|------|------------------|------|----------|
| 1 | 氏名 | name | ✅ 必須 | 文字列 |
| 2 | メールアドレス | email | ✅ 必須 | 文字列 |
| 3 | 電話番号 | phone | ⚪ 任意 | 文字列 |
| 4 | 入会日 | enrollment_date | ⚪ 任意 | 日付 |
| 5 | 目標表示 | goals_display | ⚪ 任意 | 文字列 |
| 6 | コースID | course_id | ⚪ 任意 | UUID |
| 7 | 担当講師ID | assigned_instructor_id | ⚪ 任意 | UUID |
| 8 | ステータス | status | ⚪ 任意 | 列挙型 |
| 9 | 備考 | notes | ⚪ 任意 | 文字列 |

### 標準フォーマットCSVサンプル

```csv
氏名,メールアドレス,電話番号,入会日,目標表示,コースID,担当講師ID,ステータス,備考
山田 太郎,yamada@example.com,090-1234-5678,2024-01-15,Webエンジニアとして就職する,00000000-0000-0000-0000-000000000001,12345678-1234-1234-1234-123456789012,active,特記事項なし
田中 花子,tanaka@example.com,080-9876-5432,2024-02-01,フリーランスとして独立する,00000000-0000-0000-0000-000000000002,12345678-1234-1234-1234-123456789012,active,
```

## 🎮 Article Platform連携フォーマット

### フィールドマッピング

Article PlatformからエクスポートされたCSVファイルを直接インポートできます。
以下のフィールドが自動的にマッピングされます:

| Article Platform列名 | Mentorship Manager列名 | 変換処理 |
|---------------------|------------------------|----------|
| 氏名 (name) | 氏名 (name) | そのまま |
| メールアドレス (email) | メールアドレス (email) | そのまま |
| 登録日時 (created_at) | 入会日 (enrollment_date) | 日付部分のみ抽出 |
| ロール (role) | ステータス (status) | `active`に固定 |

**無視されるフィールド:**
- ユーザーID、本名、アバターURL
- ポイント関連（current_points、total_points_earned）
- ランク関連（current_rank、rank_display_name、rank_color、rank_updated_at）
- レベル・経験値関連（level、current_exp、max_exp、total_exp、level_updated_at）
- バッジ関連（badge_id、badge_name、badge_icon、badge_color、badge_level_up_at）
- 創出価値（total_value_created）

### Article Platform連携の例

**Article Platformからエクスポートしたデータ:**
```csv
ユーザーID,氏名,本名,メールアドレス,アバターURL,ロール,現在のポイント,総獲得ポイント,現在のランク,ランク表示名,ランク色,ランク更新日時,レベル,現在の経験値,必要経験値,総経験値,レベル更新日時,バッジID,バッジ名,バッジアイコン,バッジ色,創出価値,バッジ取得日時,登録日時
550e8400-e29b-41d4-a716-446655440000,山田太郎,Yamada Taro,yamada@example.com,https://example.com/avatar1.jpg,student,1500,5000,silver,シルバー,#C0C0C0,2024-01-15 10:30:00,10,45,100,945,2024-01-20 14:22:00,b1c2d3e4-f5a6-7890-bcde-f1234567890a,🔥 ファイアクリエイター,🔥,#F59E0B,500000,2024-02-10 09:15:00,2024-01-01 00:00:00
```

**Mentorship Managerにインポートされるデータ:**
```
氏名: 山田太郎
メールアドレス: yamada@example.com
入会日: 2024-01-01
ステータス: active
```

## 🔀 柔軟なヘッダーマッピング

システムは以下の列名を自動認識します（どの表記でも対応可能）:

| フィールド | 認識される列名 |
|----------|--------------|
| 氏名 | `氏名`, `name`, `名前`, `受講生名` |
| メールアドレス | `メールアドレス`, `email`, `Eメール`, `メール` |
| 電話番号 | `電話番号`, `phone`, `電話`, `連絡先` |
| 入会日 | `入会日`, `enrollment_date`, `登録日時`, `created_at`, `入会年月日` |
| 目標表示 | `目標表示`, `goals_display`, `目標`, `ゴール` |
| コースID | `コースID`, `course_id` |
| 担当講師ID | `担当講師ID`, `assigned_instructor_id`, `講師ID` |
| ステータス | `ステータス`, `status`, `状態` |
| 備考 | `備考`, `notes`, `メモ`, `特記事項` |

**列の順序は問いません。** ヘッダー行に上記のいずれかの名前が含まれていれば、自動的に正しいフィールドにマッピングされます。

## 📝 各列の詳細仕様

### 1. 氏名 (name)

- **必須**: ✅ はい
- **データ型**: 文字列
- **最大文字数**: 制限なし（推奨: 100文字以内）
- **形式**: 任意
- **例**:
  - `山田 太郎`
  - `田中花子`
  - `Yamada Taro`
- **バリデーション**:
  - 空文字列は不可
  - 前後の空白は自動的にトリミング

### 2. メールアドレス (email)

- **必須**: ✅ はい
- **データ型**: 文字列
- **形式**: RFC 5322準拠のメールアドレス形式
- **例**:
  - `yamada@example.com`
  - `taro.yamada@company.co.jp`
  - `user+tag@domain.com`
- **バリデーション**:
  - 空文字列は不可
  - `@` を含む必要がある
  - ドメイン部分を含む必要がある
  - 正規表現: `^[^\s@]+@[^\s@]+\.[^\s@]+$`

### 3. 電話番号 (phone)

- **必須**: ⚪ 任意
- **データ型**: 文字列
- **形式**: 任意（ハイフン付き/なし両方可）
- **例**:
  - `090-1234-5678`
  - `09012345678`
  - `03-1234-5678`
- **バリデーション**:
  - 空文字列は許可
  - 形式の厳密なチェックなし

### 4. 入会日 (enrollment_date)

- **必須**: ⚪ 任意
- **データ型**: 日付
- **形式**: `YYYY-MM-DD` (ISO 8601形式)
- **例**:
  - `2024-01-01`
  - `2024-12-25`
- **バリデーション**:
  - 空文字列は許可
  - 日付形式が正しいかチェック
  - 存在しない日付は不可
- **自動変換**:
  - `2024-01-15T10:30:00.000Z` → `2024-01-15`
  - `2024-01-15 10:30:00` → `2024-01-15`
  - 日時形式の場合、日付部分のみ自動抽出

### 5. 目標表示 (goals_display)

- **必須**: ⚪ 任意
- **データ型**: 文字列（複数行可）
- **最大文字数**: 制限なし（推奨: 500文字以内）
- **例**:
  - `Webエンジニアとして就職する`
  - `3ヶ月でReactをマスターする`
- **バリデーション**:
  - 空文字列は許可

### 6. コースID (course_id)

- **必須**: ⚪ 任意
- **データ型**: UUID (v4)
- **形式**: `xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx`
- **例**:
  - `00000000-0000-0000-0000-000000000001`
- **バリデーション**:
  - 空文字列は許可
  - データベースに存在しないIDは無視される

### 7. 担当講師ID (assigned_instructor_id)

- **必須**: ⚪ 任意
- **データ型**: UUID (v4)
- **形式**: `xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx`
- **バリデーション**:
  - 空文字列は許可
  - データベースに存在しないIDは無視される

### 8. ステータス (status)

- **必須**: ⚪ 任意（デフォルト: `active`）
- **データ型**: 列挙型
- **許可される値**:
  - `active` - 在籍中
  - `on_leave` - 休学中
  - `graduated` - 卒業
  - `withdrawn` - 退会
- **自動マッピング**:
  - Article Platformの`admin`または`student` → `active`
  - 空文字列 → `active`
- **バリデーション**:
  - 許可されていない値はエラー

### 9. 備考 (notes)

- **必須**: ⚪ 任意
- **データ型**: 文字列（複数行可）
- **最大文字数**: 制限なし（推奨: 1000文字以内）
- **バリデーション**:
  - 空文字列は許可

## ⚠️ 注意事項

### データのエスケープ

CSVファイルでは、以下の場合にフィールドをダブルクォート (`"`) で囲む必要があります:

1. **カンマを含む場合**
   ```csv
   "山田 太郎, Jr.",yamada@example.com
   ```

2. **改行を含む場合**
   ```csv
   "目標:
   Webエンジニアになる"
   ```

3. **ダブルクォートを含む場合**（ダブルクォートを2つ重ねる）
   ```csv
   "彼は""エンジニア""を目指している"
   ```

### 文字エンコーディング

- **UTF-8 (BOM付き)** を推奨
- Excel等で作成する場合は、保存時に「CSV UTF-8 (カンマ区切り)」を選択
- 日本語を含むため、Shift_JISやEUC-JPは非推奨

### 空のフィールド

任意項目で値を設定しない場合は、カンマを省略せず空のまま残してください:

```csv
氏名,メールアドレス,電話番号,入会日,目標表示,コースID,担当講師ID,ステータス,備考
山田 太郎,yamada@example.com,,,,,,active,
```

## ✅ バリデーションルール

### 必須チェック

- 氏名が空でないこと
- メールアドレスが空でないこと
- メールアドレスが正しい形式であること

### 形式チェック

- メールアドレス: `^[^\s@]+@[^\s@]+\.[^\s@]+$`
- 入会日: `YYYY-MM-DD` 形式（例: `2024-01-15`）または日時形式から自動変換
- ステータス: `active`, `on_leave`, `graduated`, `withdrawn` のいずれか（または`admin`/`student`から自動変換）

### 外部キー参照

- コースIDがデータベースに存在すること（存在しない場合は無視）
- 担当講師IDがデータベースに存在すること（存在しない場合は無視）

## 🔄 インポート処理フロー

```
1. CSVファイルアップロード
   ↓
2. 文字エンコーディング検証（UTF-8対応）
   ↓
3. RFC 4180準拠パース（ダブルクォートエスケープ対応）
   ↓
4. ヘッダー行の自動検出とフィールドマッピング
   ↓
5. 各行のパース
   ↓
6. 各フィールドのバリデーション
   ↓
7. 日時→日付の自動変換
   ↓
8. ステータスの自動マッピング
   ↓
9. データベースへの挿入
   ↓
10. 結果レポート生成
    - 成功件数
    - 失敗件数
    - エラー詳細（行番号、フィールド名、エラーメッセージ）
```

## 📊 エラーハンドリング

### エラー発生時の動作

- **行ごとの処理**: 1行でもエラーがあった場合、その行のみスキップされる
- **部分的な成功**: エラーのない行は正常に登録される
- **エラーレポート**: すべてのエラーが詳細に報告される

### エラーメッセージの例

```json
{
  "success": 10,
  "failed": 2,
  "errors": [
    {
      "row": 3,
      "field": "メールアドレス",
      "message": "有効なメールアドレスを入力してください"
    },
    {
      "row": 5,
      "field": "入会日",
      "message": "日付はYYYY-MM-DD形式で入力してください（例: 2024-01-01）"
    }
  ]
}
```

## 🛠️ 外部システムからのCSV生成

### Article Platformからのエクスポート

Article Platformで「ユーザー情報エクスポート」を実行すると、24列のCSVファイルがダウンロードされます。
このファイルを**そのまま**Mentorship Managerにインポートできます。

**手順:**
1. Article Platformで管理者コンソールにログイン
2. 「ユーザー情報エクスポート」をクリック
3. ダウンロードされたCSVファイルを保存
4. Mentorship Managerの「CSV一括登録」タブでアップロード
5. インポート開始

### Pythonでのカスタム生成例

```python
import csv
from datetime import datetime

# データの準備
students = [
    {
        "last_name": "山田",
        "first_name": "太郎",
        "email": "yamada@example.com",
        "phone": "090-1234-5678",
        "enrollment_date": datetime(2024, 1, 15),
        "goals": "Webエンジニアとして就職する",
        "status": "active"
    }
]

# CSV出力（Mentorship Manager標準フォーマット）
with open('students_import.csv', 'w', encoding='utf-8-sig', newline='') as f:
    writer = csv.writer(f)

    # ヘッダー
    writer.writerow([
        '氏名', 'メールアドレス', '電話番号', '入会日',
        '目標表示', 'コースID', '担当講師ID', 'ステータス', '備考'
    ])

    # データ行
    for student in students:
        writer.writerow([
            f"{student['last_name']} {student['first_name']}",
            student['email'],
            student.get('phone', ''),
            student['enrollment_date'].strftime('%Y-%m-%d'),
            student.get('goals', ''),
            '',  # コースID
            '',  # 担当講師ID
            student['status'],
            ''   # 備考
        ])
```

### Excel/スプレッドシートからの生成

**Excel:**
1. データを用意
2. 1行目にヘッダー（列名）を入力
3. 「ファイル」→「名前を付けて保存」
4. ファイル形式を「CSV UTF-8 (カンマ区切り) (*.csv)」に選択
5. 保存

**Googleスプレッドシート:**
1. データを用意
2. 1行目にヘッダー（列名）を入力
3. 「ファイル」→「ダウンロード」→「カンマ区切りの値 (.csv, 現在のシート)」

## 📞 サポート

CSV形式やインポートに関する質問がある場合は、システム管理者にお問い合わせください。

### よくある質問

**Q: Article PlatformのCSVをそのままインポートできますか？**
A: はい、Article Platformのエクスポート形式（24列）に完全対応しています。ヘッダー行を自動検出して必要なフィールドのみをインポートします。

**Q: 列の順序を変更してもインポートできますか？**
A: はい、ヘッダー行から列を自動検出するため、列の順序は問いません。

**Q: 日時形式の入会日でもインポートできますか？**
A: はい、`2024-01-15T10:30:00.000Z`や`2024-01-15 10:30:00`などの日時形式の場合、自動的に日付部分（`2024-01-15`）のみを抽出します。

**Q: コースIDや担当講師IDはどこで確認できますか？**
A: アプリケーション内の各一覧画面、またはシステム管理者から取得してください。

**Q: 大量のデータをインポートできますか？**
A: 技術的には制限はありませんが、1000件以上の場合は複数回に分けることを推奨します。

**Q: インポート後にデータを修正できますか？**
A: はい、アプリケーション内で個別に編集可能です。

**Q: 既存の受講生情報を更新できますか？**
A: いいえ、このCSVインポートは新規登録専用です。更新は個別に行ってください。

---

**バージョン**: 2.0
**最終更新日**: 2025-11-26
**更新内容**: Article Platform連携対応、ヘッダー自動検出機能追加
**作成者**: Mentorship Manager 開発チーム
