# ユーザー情報CSV一括エクスポート仕様書

## 📋 概要

Article Platformの管理者コンソールでは、ユーザー情報をCSVファイル形式で一括エクスポート（ダウンロード）できます。
この仕様書では、エクスポートされるCSVファイルの形式、各列の詳細、データ形式を説明します。

## 📄 CSVファイル形式

### 基本情報

- **ファイル形式**: CSV (Comma-Separated Values)
- **文字エンコーディング**: UTF-8 (BOM付き)
- **改行コード**: LF (`\n`) または CRLF (`\r\n`)
- **区切り文字**: カンマ (`,`)
- **ヘッダー行**: あり（1行目）
- **ファイル名形式**: `users_export_YYYYMMDD_HHmmss.csv`

### ファイル構造

```
ヘッダー行（1行目）
データ行1（2行目）
データ行2（3行目）
...
```

## 📊 列の定義

### 列の順序

| 列番号 | 列名 | 英語フィールド名 | データ型 | 説明 |
|--------|------|------------------|----------|------|
| 1 | ユーザーID | id | UUID | システム内部のユーザー識別子 |
| 2 | 氏名 | name | 文字列 | ユーザーの表示名 |
| 3 | 本名 | real_name | 文字列 | ユーザーの本名（任意） |
| 4 | メールアドレス | email | 文字列 | ユーザーのメールアドレス |
| 5 | アバターURL | avatar_url | URL | プロフィール画像のURL（任意） |
| 6 | ロール | role | 列挙型 | ユーザーの権限レベル |
| 7 | 現在のポイント | current_points | 数値 | ランク昇格用の現在ポイント |
| 8 | 総獲得ポイント | total_points_earned | 数値 | これまでに獲得した累計ポイント |
| 9 | 現在のランク | current_rank | 文字列 | 現在のランクコード |
| 10 | ランク表示名 | rank_display_name | 文字列 | ランクの日本語表示名 |
| 11 | ランク色 | rank_color | カラーコード | ランクのテーマカラー（16進数） |
| 12 | ランク更新日時 | rank_updated_at | 日時 | 最後にランクが更新された日時 |
| 13 | レベル | level | 数値 | ユーザーの現在レベル |
| 14 | 現在の経験値 | current_exp | 数値 | 次のレベルまでの現在経験値 |
| 15 | 必要経験値 | max_exp | 数値 | 次のレベルに必要な経験値 |
| 16 | 総経験値 | total_exp | 数値 | これまでに獲得した累計経験値 |
| 17 | レベル更新日時 | level_updated_at | 日時 | 最後にレベルが更新された日時 |
| 18 | バッジID | badge_id | UUID | 現在のバッジの識別子（任意） |
| 19 | バッジ名 | badge_name | 文字列 | バッジの表示名（任意） |
| 20 | バッジアイコン | badge_icon | 絵文字 | バッジのアイコン絵文字（任意） |
| 21 | バッジ色 | badge_color | カラーコード | バッジのテーマカラー（任意） |
| 22 | 創出価値 | total_value_created | 数値 | システムツール記事で創出した価値（円） |
| 23 | バッジ取得日時 | badge_level_up_at | 日時 | 最後にバッジレベルアップした日時（任意） |
| 24 | 登録日時 | created_at | 日時 | ユーザーがシステムに登録された日時 |

### 各列の詳細仕様

#### 1. ユーザーID (id)

- **データ型**: UUID (v4)
- **形式**: `xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx`
- **例**:
  - `550e8400-e29b-41d4-a716-446655440000`
  - `a1b2c3d4-e5f6-7890-abcd-ef1234567890`
- **NULL許可**: 不可
- **説明**: システム内部でユーザーを一意に識別するID

#### 2. 氏名 (name)

- **データ型**: 文字列
- **最大文字数**: 制限なし（推奨: 100文字以内）
- **例**:
  - `山田太郎`
  - `Yamada Taro`
  - `田中花子`
- **NULL許可**: 不可
- **説明**: ユーザーが設定した表示名（プロフィール名）

#### 3. 本名 (real_name)

- **データ型**: 文字列
- **最大文字数**: 制限なし（推奨: 100文字以内）
- **例**:
  - `山田 太郎`
  - `Yamada Taro`
- **NULL許可**: 可（未設定の場合は空文字列）
- **説明**: ユーザーの実名（任意項目）

#### 4. メールアドレス (email)

- **データ型**: 文字列
- **形式**: RFC 5322準拠のメールアドレス
- **例**:
  - `yamada@example.com`
  - `taro.yamada@company.co.jp`
- **NULL許可**: 不可
- **説明**: ユーザーのログイン用メールアドレス

#### 5. アバターURL (avatar_url)

- **データ型**: URL文字列
- **形式**: `https://` または `http://` で始まるURL
- **例**:
  - `https://storage.supabase.com/avatars/user123.jpg`
  - `https://example.com/images/avatar.png`
- **NULL許可**: 可（未設定の場合は空文字列）
- **説明**: プロフィール画像のURL

#### 6. ロール (role)

- **データ型**: 列挙型
- **許可される値**:
  - `admin` - 管理者
  - `student` - 一般ユーザー
- **例**:
  - `admin`
  - `student`
- **NULL許可**: 不可（デフォルト: `student`）
- **説明**: ユーザーの権限レベル

#### 7. 現在のポイント (current_points)

- **データ型**: 整数
- **範囲**: 0以上
- **例**:
  - `1500`
  - `0`
  - `99999`
- **NULL許可**: 不可（デフォルト: 0）
- **説明**: ランク昇格に使用される現在のポイント数

#### 8. 総獲得ポイント (total_points_earned)

- **データ型**: 整数
- **範囲**: 0以上
- **例**:
  - `5000`
  - `150000`
- **NULL許可**: 不可（デフォルト: 0）
- **説明**: ユーザーがこれまでに獲得した累計ポイント数

#### 9. 現在のランク (current_rank)

- **データ型**: 文字列
- **例**:
  - `bronze`
  - `silver`
  - `gold`
  - `platinum`
  - `diamond`
  - `master`
  - `grandmaster`
  - `challenger`
  - `predator`
- **NULL許可**: 不可（デフォルト: 最低ランク）
- **説明**: 現在のランクを識別するコード（データベースの`main_rank_settings.name`に対応）

#### 10. ランク表示名 (rank_display_name)

- **データ型**: 文字列
- **例**:
  - `ブロンズ`
  - `シルバー`
  - `ゴールド`
  - `プラチナ`
  - `ダイヤモンド`
- **NULL許可**: 可
- **説明**: ランクの日本語表示名

#### 11. ランク色 (rank_color)

- **データ型**: カラーコード（16進数）
- **形式**: `#RRGGBB`
- **例**:
  - `#8B7355` (ブロンズ)
  - `#C0C0C0` (シルバー)
  - `#FFD700` (ゴールド)
- **NULL許可**: 可
- **説明**: ランクのテーマカラー

#### 12. ランク更新日時 (rank_updated_at)

- **データ型**: 日時（ISO 8601形式）
- **形式**: `YYYY-MM-DD HH:mm:ss` または `YYYY-MM-DDTHH:mm:ss.sssZ`
- **例**:
  - `2024-01-15 10:30:00`
  - `2024-12-25T15:45:30.123Z`
- **NULL許可**: 可
- **説明**: 最後にランクが更新された日時

#### 13. レベル (level)

- **データ型**: 整数
- **範囲**: 1以上
- **例**:
  - `1`
  - `10`
  - `50`
- **NULL許可**: 不可（デフォルト: 1）
- **説明**: ユーザーの現在レベル

#### 14. 現在の経験値 (current_exp)

- **データ型**: 整数
- **範囲**: 0以上
- **例**:
  - `45`
  - `0`
  - `99`
- **NULL許可**: 不可（デフォルト: 0）
- **説明**: 次のレベルまでに必要な現在の経験値（0〜max_exp）

#### 15. 必要経験値 (max_exp)

- **データ型**: 整数
- **範囲**: 1以上
- **例**:
  - `100`
- **NULL許可**: 不可（デフォルト: 100）
- **説明**: 次のレベルアップに必要な経験値（通常は100固定）

#### 16. 総経験値 (total_exp)

- **データ型**: 整数
- **範囲**: 0以上
- **例**:
  - `945`
  - `0`
  - `50000`
- **NULL許可**: 不可（デフォルト: 0）
- **説明**: ユーザーがこれまでに獲得した累計経験値
- **計算式**: `level = Math.floor(total_exp / 100) + 1`

#### 17. レベル更新日時 (level_updated_at)

- **データ型**: 日時（ISO 8601形式）
- **形式**: `YYYY-MM-DD HH:mm:ss` または `YYYY-MM-DDTHH:mm:ss.sssZ`
- **例**:
  - `2024-01-20 14:22:00`
  - `2024-12-30T18:15:45.789Z`
- **NULL許可**: 可
- **説明**: 最後にレベルが更新された日時

#### 18. バッジID (badge_id)

- **データ型**: UUID (v4)
- **形式**: `xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx`
- **例**:
  - `b1c2d3e4-f5a6-7890-bcde-f1234567890a`
- **NULL許可**: 可（バッジ未取得の場合は空文字列）
- **説明**: 現在のバッジレベルの識別子

#### 19. バッジ名 (badge_name)

- **データ型**: 文字列
- **例**:
  - `🌱 スタータークリエイター`
  - `🔥 ファイアクリエイター`
  - `💎 ダイヤモンドクリエイター`
  - `👑 レジェンドクリエイター`
- **NULL許可**: 可（バッジ未取得の場合は空文字列）
- **説明**: バッジの表示名

#### 20. バッジアイコン (badge_icon)

- **データ型**: 絵文字（Unicode文字列）
- **例**:
  - `🌱`
  - `🔥`
  - `💎`
  - `👑`
- **NULL許可**: 可（バッジ未取得の場合は空文字列）
- **説明**: バッジを表すアイコン絵文字

#### 21. バッジ色 (badge_color)

- **データ型**: カラーコード（16進数）
- **形式**: `#RRGGBB`
- **例**:
  - `#10B981` (緑)
  - `#F59E0B` (オレンジ)
  - `#3B82F6` (青)
- **NULL許可**: 可
- **説明**: バッジのテーマカラー

#### 22. 創出価値 (total_value_created)

- **データ型**: 数値（浮動小数点）
- **範囲**: 0以上
- **単位**: 円（¥）
- **例**:
  - `500000`
  - `0`
  - `12345678.50`
- **NULL許可**: 可（デフォルト: 0）
- **説明**: システムツール記事で創出した累計価値（円換算）

#### 23. バッジ取得日時 (badge_level_up_at)

- **データ型**: 日時（ISO 8601形式）
- **形式**: `YYYY-MM-DD HH:mm:ss` または `YYYY-MM-DDTHH:mm:ss.sssZ`
- **例**:
  - `2024-02-10 09:15:00`
  - `2024-11-05T12:30:15.456Z`
- **NULL許可**: 可
- **説明**: 最後にバッジレベルアップした日時

#### 24. 登録日時 (created_at)

- **データ型**: 日時（ISO 8601形式）
- **形式**: `YYYY-MM-DD HH:mm:ss` または `YYYY-MM-DDTHH:mm:ss.sssZ`
- **例**:
  - `2024-01-01 00:00:00`
  - `2024-06-15T10:30:00.000Z`
- **NULL許可**: 不可
- **説明**: ユーザーがシステムに登録された日時

## 📝 CSVサンプル

### 基本的な例

```csv
ユーザーID,氏名,本名,メールアドレス,アバターURL,ロール,現在のポイント,総獲得ポイント,現在のランク,ランク表示名,ランク色,ランク更新日時,レベル,現在の経験値,必要経験値,総経験値,レベル更新日時,バッジID,バッジ名,バッジアイコン,バッジ色,創出価値,バッジ取得日時,登録日時
550e8400-e29b-41d4-a716-446655440000,山田太郎,Yamada Taro,yamada@example.com,https://example.com/avatar1.jpg,student,1500,5000,silver,シルバー,#C0C0C0,2024-01-15 10:30:00,10,45,100,945,2024-01-20 14:22:00,b1c2d3e4-f5a6-7890-bcde-f1234567890a,🔥 ファイアクリエイター,🔥,#F59E0B,500000,2024-02-10 09:15:00,2024-01-01 00:00:00
a1b2c3d4-e5f6-7890-abcd-ef1234567890,田中花子,Tanaka Hanako,tanaka@example.com,,admin,3000,15000,gold,ゴールド,#FFD700,2024-02-01 08:45:00,25,70,100,2470,2024-02-05 16:30:00,c2d3e4f5-a6b7-8901-cdef-234567890abc,💎 ダイヤモンドクリエイター,💎,#3B82F6,1200000,2024-02-15 11:20:00,2023-12-01 12:00:00
```

### 最小限の例（バッジなし）

```csv
ユーザーID,氏名,本名,メールアドレス,アバターURL,ロール,現在のポイント,総獲得ポイント,現在のランク,ランク表示名,ランク色,ランク更新日時,レベル,現在の経験値,必要経験値,総経験値,レベル更新日時,バッジID,バッジ名,バッジアイコン,バッジ色,創出価値,バッジ取得日時,登録日時
550e8400-e29b-41d4-a716-446655440000,山田太郎,,yamada@example.com,,student,0,0,bronze,ブロンズ,#8B7355,,1,0,100,0,,,,,,,0,,2024-01-01 00:00:00
```

## ⚠️ 注意事項

### データのエスケープ

CSVファイルでは、以下の場合にフィールドをダブルクォート (`"`) で囲む必要があります:

1. **カンマを含む場合**
   ```csv
   "山田 太郎, Jr.",yamada@example.com
   ```

2. **改行を含む場合**（通常はデータに改行は含まれない想定）
   ```csv
   "備考:
   特記事項あり"
   ```

3. **ダブルクォートを含む場合**（ダブルクォートを2つ重ねる）
   ```csv
   "彼は""エンジニア""です"
   ```

### 文字エンコーディング

- **UTF-8 (BOM付き)** で出力されます
- Excel等で開く場合、文字化けを防ぐためBOM付きが推奨されます
- 日本語を正しく表示するため、Shift_JISやEUC-JPは使用しません

### 空のフィールド

任意項目で値が設定されていない場合は、空文字列として出力されます:

```csv
ユーザーID,氏名,本名,...
abc-123,山田太郎,,...
```

### 日時形式

日時データは以下のいずれかの形式で出力されます:

- **ISO 8601形式（UTC）**: `2024-01-15T10:30:00.000Z`
- **ローカル形式**: `2024-01-15 10:30:00`

## 📊 エクスポート機能

### エクスポート対象

1. **全ユーザーエクスポート**
   - データベースに登録されているすべてのユーザー情報をエクスポート

2. **選択ユーザーエクスポート**（オプション）
   - チェックボックスで選択したユーザーのみをエクスポート

3. **検索結果エクスポート**（オプション）
   - 検索フィルタリング後の結果をエクスポート

### エクスポート処理フロー

```
1. エクスポートボタンクリック
   ↓
2. 対象ユーザーの抽出
   ↓
3. 各ユーザーのゲーミフィケーションデータ取得
   - ポイント・ランク情報
   - レベル・経験値情報
   - バッジ情報
   ↓
4. CSVデータ生成
   - ヘッダー行の作成
   - データ行の作成（エスケープ処理含む）
   ↓
5. ファイルダウンロード
   - ファイル名: users_export_YYYYMMDD_HHmmss.csv
   - Content-Type: text/csv; charset=utf-8
```

## 🛠️ 外部システムでの活用例

### データ分析・可視化

エクスポートしたCSVファイルは、以下のツールで分析できます:

- **Excel / Google スプレッドシート**: 基本的な集計・グラフ作成
- **Power BI / Tableau**: 高度なビジュアル分析
- **Python (pandas)**: プログラムによる詳細分析

### Pythonでの読み込み例

```python
import pandas as pd

# CSVファイルの読み込み（UTF-8 BOM対応）
df = pd.read_csv('users_export_20240115_103000.csv', encoding='utf-8-sig')

# 基本統計
print("総ユーザー数:", len(df))
print("平均ポイント:", df['現在のポイント'].mean())
print("平均レベル:", df['レベル'].mean())

# ランク別集計
rank_counts = df['ランク表示名'].value_counts()
print("\nランク別ユーザー数:")
print(rank_counts)

# 管理者の抽出
admins = df[df['ロール'] == 'admin']
print("\n管理者数:", len(admins))
```

### Excelでの開き方

1. CSVファイルをダウンロード
2. Excelで「ファイル」→「開く」
3. ファイルを選択
4. UTF-8 (BOM付き) として開かれ、日本語が正しく表示されます

## 📞 サポート

CSV形式やエクスポートに関する質問がある場合は、システム管理者にお問い合わせください。

### よくある質問

**Q: エクスポートできるユーザー数に制限はありますか？**
A: 技術的な制限はありませんが、大量のユーザー（10,000件以上）の場合は処理に時間がかかる場合があります。

**Q: エクスポートしたデータの個人情報保護はどうすればよいですか？**
A: メールアドレスや本名などの個人情報が含まれるため、ダウンロード後のファイルは適切に管理し、不要になったら削除してください。

**Q: 定期的に自動でエクスポートできますか？**
A: 現在、自動エクスポート機能はありません。必要に応じて手動でエクスポートしてください。

**Q: 過去の時点のデータをエクスポートできますか？**
A: いいえ、エクスポートされるのは現在の最新データのみです。履歴データが必要な場合は、別途データベースバックアップから取得してください。

---

**バージョン**: 1.0
**最終更新日**: 2025-11-26
**作成者**: Article Platform 開発チーム
